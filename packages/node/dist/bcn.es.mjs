import t from"body-parser";import e from"cors";import r from"express";import n from"http";import*as a from"zeromq";import s from"express-rate-limit";import*as o from"@bitcoin-computer/tiny-secp256k1";import{networks as i,bufferUtils as c,crypto as u,address as l,payments as f,Psbt as p,Transaction as d,initEccLib as v}from"@bitcoin-computer/nakamotojs";import h from"dotenv";import m from"winston";import y from"winston-daily-rotate-file";import g from"pg-promise";import w from"pg-monitor";import{backOff as S}from"exponential-backoff";import E from"fs";import{ECPairFactory as b}from"ecpair";import I from"bitcoind-rpc";import T from"util";import{Computer as O}from"@bitcoin-computer/lib";import $ from"elliptic";import x from"hash.js";import j,{dirname as R}from"path";import{fileURLToPath as N}from"url";import B from"net";h.config();const L=process.env.CHAIN;const A=process.env.NETWORK;const{PORT:P}=process.env;const{POSTGRES_USER:M}=process.env;const{POSTGRES_PASSWORD:k}=process.env;const{POSTGRES_DB:C}=process.env;const{POSTGRES_HOST:F}=process.env;const{POSTGRES_PORT:_}=process.env;const{RPC_USER:D}=process.env;const{RPC_PASSWORD:H}=process.env;process.env;const{RPC_HOST:U}=process.env;const{RPC_PORT:K}=process.env;const{RPC_PROTOCOL:z}=process.env;const{ZMQ_URL:W}=process.env;const{DEFAULT_WALLET:Y}=process.env;const{ALLOWED_RPC_METHODS:G}=process.env;const{DEBUG_MODE:V}=process.env;const{LOG_MAX_FILES:J}=process.env;const{LOG_MAX_SIZE:q}=process.env;const{LOG_ZIP:Q}=process.env;const{BANNED_COUNTRIES:Z}=process.env;const X=process.env.QUERY_LIMIT||"1000";process.env.WORKER_ID,process.env.SYNC_NON_STANDARD,process.env.NUM_WORKERS;const tt=process.env.BCN_URL||`http://127.0.0.1:${P}`;const et=process.env.BCN_ENV||"dev";m.addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const rt=m.format.combine(m.format.colorize(),m.format.timestamp({format:"YYYY-MM-DD HH:mm:ss:ms"}),m.format.json(),m.format.printf((t=>`${t.timestamp} [${t.level.slice(5).slice(0,-5)}] ${t.message}`)));const nt={zippedArchive:!!Q,maxSize:q,maxFiles:J,dirname:"logs"};const at=[];"dev"===et&&at.push(new m.transports.Console({format:m.format.combine(m.format.colorize(),m.format.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),m.format.printf((t=>`${t.timestamp} ${t.level} ${t.message}`)))}));const st=parseInt(V,10);st>=0&&at.push(new y({filename:"error-%DATE%.log",datePattern:"YYYY-MM-DD",level:"error",...nt})),st>=1&&at.push(new y({filename:"warn-%DATE%.log",datePattern:"YYYY-MM-DD",level:"warn",...nt})),st>=2&&at.push(new y({filename:"info-%DATE%.log",datePattern:"YYYY-MM-DD",level:"info",...nt})),st>=3&&at.push(new y({filename:"http-%DATE%.log",datePattern:"YYYY-MM-DD",level:"http",...nt})),st>=4&&at.push(new y({filename:"debug-%DATE%.log",datePattern:"YYYY-MM-DD",level:"debug",...nt}));const ot=m.createLogger({levels:{error:0,warn:1,info:2,http:3,debug:4},format:rt,transports:at,exceptionHandlers:[new m.transports.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new m.transports.File({filename:"logs/rejections.log"})]});const it=()=>"dev"===et;function ct(t=L,e=A){switch(t){case"BTC":switch(e){case"mainnet":return i.bitcoin;case"testnet":return i.testnet;case"regtest":return i.regtest;default:throw new Error(`Invalid network ${e}`)}case"LTC":switch(e){case"mainnet":return i.litecoin;case"testnet":return i.litecointestnet;case"regtest":return i.litecoinregtest;default:throw new Error(`Invalid network ${e}`)}default:throw new Error(`Invalid chain ${e}`)}}const{version:ut}=JSON.parse(E.readFileSync("package.json","utf8"));const lt=ut||process.env.SERVER_VERSION;const ft=parseInt(process.env.MWEB_HEIGHT||"",10)||432;const pt={error:(t,e)=>{if(e.cn){const{host:r,port:n,database:a,user:s,password:o}=e.cn;ot.debug(`Waiting for db to start { message:${t.message} host:${r}, port:${n}, database:${a}, user:${s}, password: ${o}`)}},noWarnings:!0};it()&&parseInt(V,10)>0&&(w.isAttached()?w.detach():(w.attach(pt),w.setTheme("matrix")));const dt=g(pt)({host:F,port:parseInt(_,10),database:C,user:M,password:k,allowExitOnIdle:!0,idleTimeoutMillis:100});const{PreparedStatement:vt}=g;class ht{static async select(t){const e=new vt({name:`OffChain.select.${Math.random()}`,text:'SELECT "data" FROM "OffChain" WHERE "id" = $1',values:[t]});return dt.oneOrNone(e)}static async insert({id:t,data:e}){const r=new vt({name:`OffChain.insert.${Math.random()}`,text:'INSERT INTO "OffChain" ("id", "data") VALUES ($1, $2) ON CONFLICT DO NOTHING',values:[t,e]});return dt.none(r)}static async delete(t){const e=new vt({name:`OffChain.delete.${Math.random()}`,text:'WITH deleted AS (DELETE FROM "OffChain" WHERE "id" = $1 RETURNING *) SELECT count(*) FROM deleted;',values:[t]});return(await dt.any(e))[0].count>0}}class mt{static async select(t){const e=await ht.select(t);return e?.data||null}static async insert(t){return ht.insert(t)}static async delete(t){return ht.delete(t)}}const yt=r.Router();yt.get("/:id",(async({params:{id:t},url:e},r)=>{try{const e=await mt.select(t);e?r.status(200).json(e):r.status(403).json({error:"No entry found."})}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(500).json({error:t.message})}})),yt.post("/",(async(t,e)=>{const{body:{data:r},url:n}=t;try{const n=u.sha256(Buffer.from(r)).toString("hex");await mt.insert({id:n,data:r});const a=`${t.protocol}://${t.get("host")}/store/${n}`;e.status(201).json({_url:a})}catch(t){ot.error(`POST ${n} failed with error '${t.message}'`),e.status(500).json({error:t.message})}})),yt.delete("/:id",(async(t,e)=>{e.status(500).json({error:"Deletions are not supported yet."})}));const{PreparedStatement:gt}=g;class wt{static async getBalance(t){const e=new gt({name:`Utxos.getBalance.${Math.random()}`,text:'SELECT sum("satoshis") as "satoshis" FROM "Utxos" WHERE "address" = $1',values:[t]});const r=await dt.oneOrNone(e);return parseInt(r?.satoshis,10)||0}static async select(t){const e=new gt({name:`Utxos.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev", split_part(rev, \':\', 1) AS "txId", cast(split_part(rev, \':\', 2) as INTEGER) AS "vout" FROM "Utxos" WHERE "address" = $1',values:[t]});return(await dt.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)||0})))}static async selectByScriptHex(t){const e=new gt({name:`Utxos.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev", split_part(rev, \':\', 1) AS "txId", cast(split_part(rev, \':\', 2) as INTEGER) AS "vout" FROM "Utxos" WHERE "scriptPubKey" = $1',values:[t]});return(await dt.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)||0})))}static async selectByPk(t){const e=new gt({name:`Utxos.selectByPk.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev", split_part(rev, \':\', 1) AS "txId", cast(split_part(rev, \':\', 2) as INTEGER) AS "vout", "publicKeys" FROM "Utxos" WHERE $1 = ANY ("publicKeys")',values:[t]});return(await dt.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)})))}}class St{static async getBalance(t){return wt.getBalance(t)}static async select(t){return wt.select(t)}static async selectByScriptHex(t){return wt.selectByScriptHex(t)}static async selectByPk(t){return wt.selectByPk(t)}}class Et{static getBalance=async t=>St.getBalance(t);static select=async t=>St.select(t);static selectByScriptHex=async t=>St.selectByScriptHex(t);static selectByPk=async t=>St.selectByPk(t)}function bt(t){return/^[0-9A-Fa-f]{64}:\d+$/.test(t)}function It(t){if(!bt(t))throw new Error("Invalid rev")}const{PreparedStatement:Tt}=g;class Ot{static async query(t){const{publicKey:e,hash:r,limit:n,offset:a,order:s,ids:o,mod:i}=t;const c=parseInt(X,10);if(n&&parseInt(n||"",10)>c||o&&o.length>c)throw new Error(`Can't fetch more than ${X} revs.`);if(s&&"ASC"!==s&&"DESC"!==s)throw new Error("Invalid order");let u;u=o?.length?'SELECT "rev", "id", array_position($1, "id") as ord\n        FROM "NonStandard" \n        WHERE true ':'SELECT "rev"\n        FROM "NonStandard"\n        WHERE true ';const l=[];o&&(o.map(It),l.push(o),u+=` AND "id" = ANY ($${l.length})`),r&&(l.push(r),u+=` AND "hash" = $${l.length}`),i&&(l.push(i),u+=` AND "mod" = $${l.length}`),e&&(l.push(e),u+=` AND $${l.length} = ANY ("publicKeys")`),s?(u+=` order by "lastUpdated" ${s}`,o?.length&&(u+=", ord")):o?.length&&(u+=" order by ord"),l.push(n||c),u+=` limit $${l.length}`,a&&(l.push(a),u+=` offset $${l.length}`);const f=new Tt({name:`NonStandard.query.${Math.random()}`,text:u,values:l});const p=await dt.any(f);const d=p.map((t=>t.rev));if(o?.length&&p.length!==o.length){const t={};return p.forEach((e=>{t[e.id]=e.rev})),o?.map((e=>t[e]??null))??[]}return d}static async insert({id:t,rev:e,publicKeys:r,hash:n,mod:a}){const s=new Tt({name:`NonStandard.insert.${Math.random()}`,text:'INSERT INTO "NonStandard"("id", "rev", "publicKeys", "hash", "mod") VALUES ($1, $2, $3, $4, $5) ON CONFLICT DO NOTHING',values:[t,e,r,n,a]});await dt.none(s)}static async update({id:t,rev:e,publicKeys:r}){const n=new Tt({name:`NonStandard.update.${Math.random()}`,text:'UPDATE "NonStandard" SET "rev"=$2, "publicKeys"=$3 WHERE "id" = $1',values:[t,e,r]});return dt.none(n)}static async delete({rev:t}){const e=new Tt({name:`NonStandard.delete.${Math.random()}`,text:'DELETE FROM "NonStandard" WHERE "rev" = $1',values:[t]});await dt.none(e)}static async getRevsByIds(t){const e=parseInt(X,10);if(t&&t.length>e)throw new Error(`Can't fetch more than ${X} revs.`);const r=new Tt({name:`NonStandard.getRevsByIds.${Math.random()}`,text:'SELECT "rev" FROM "NonStandard" WHERE "id" LIKE ANY($1)',values:[[t]]});return dt.any(r)}static async select(t){const e=new Tt({name:`NonStandard.select.${Math.random()}`,text:'SELECT "id", "hash", "mod" FROM "NonStandard" WHERE "rev" = $1',values:[t]});return dt.oneOrNone(e)}}class $t{static async select(t){return Ot.select(t)}static async query(t){return Ot.query(t)}static async getRevsByIds(t){return Ot.getRevsByIds(t)}static async insert(t){return Ot.insert(t)}static async update(t){return Ot.update(t)}static async delete(t){return Ot.delete({rev:t})}}const{PreparedStatement:xt}=g;class jt{static async getId(t){const e=new xt({name:`RevToId.select.${Math.random()}`,text:'SELECT "id" FROM "RevToId" WHERE "rev" = $1',values:[t]});const r=await dt.oneOrNone(e);return r?.id}static async insert(t){const e=new xt({name:`RevToId.insert.${Math.random()}`,text:'INSERT INTO "RevToId"("rev", "id") VALUES ($1, $2)  ON CONFLICT DO NOTHING',values:[t.rev,t.id]});await dt.none(e)}}class Rt{static async getId(t){return jt.getId(t)}static async insert(t){return jt.insert(t)}}class Nt{static add=async t=>{let e;let r;try{({zip:e,outData:r}=t)}catch{return}for(let t=0;t<e.length;t+=1){const[n,a]=e[t];const{exp:s="",_owners:o=[],mod:i=""}=r[t]||{};if(!n&&a)It(a),await $t.insert({id:a,rev:a,publicKeys:o,hash:u.sha256(Buffer.from(s)).toString("hex"),mod:i}),await Rt.insert({rev:a,id:a});else if(n&&a){const{id:t,hash:e,mod:r}=await $t.select(n)||{};await $t.update({id:t,rev:a,publicKeys:o,hash:e,mod:r}),await Rt.insert({rev:a,id:t})}else n&&!a&&await $t.delete(n)}};static query=async t=>$t.query(t);static getRevsByIds=async t=>(await $t.getRevsByIds(t)).map((t=>t.rev))}const Bt={protocol:z,user:D,pass:H,host:U,port:parseInt(K,10)};const Lt=new I(Bt);const At=T.promisify(I.prototype.createwallet.bind(Lt));const Pt=T.promisify(I.prototype.generateToAddress.bind(Lt));const Mt=T.promisify(I.prototype.getaddressinfo.bind(Lt));const kt=T.promisify(I.prototype.getBlock.bind(Lt));const Ct=T.promisify(I.prototype.getBlockchainInfo.bind(Lt));const Ft=T.promisify(I.prototype.getBlockHash.bind(Lt));const _t=T.promisify(I.prototype.getRawTransaction.bind(Lt));const Dt=T.promisify(I.prototype.getRawTransaction.bind(Lt));const Ht=T.promisify(I.prototype.getTransaction.bind(Lt));const Ut=T.promisify(I.prototype.getNewAddress.bind(Lt));const Kt={createwallet:At,generateToAddress:Pt,getaddressinfo:Mt,getBlock:kt,getBlockchainInfo:Ct,getBlockHash:Ft,getRawTransaction:_t,getTransaction:Ht,importaddress:T.promisify(I.prototype.importaddress.bind(Lt)),listunspent:T.promisify(I.prototype.listunspent.bind(Lt)),sendRawTransaction:T.promisify(I.prototype.sendRawTransaction.bind(Lt)),getNewAddress:Ut,sendToAddress:T.promisify(I.prototype.sendToAddress.bind(Lt)),getRawTransactionJSON:Dt};class zt{static async getTransaction(t){const{result:e}=await Kt.getTransaction(t);return e}static async getBulkTransactions(t){return(await Promise.all(t.map((t=>Kt.getRawTransaction(t))))).map((t=>t.result))}static async getRawTransactionsJSON(t){return{txId:(e=(await Kt.getRawTransactionJSON(t,1)).result).txid,txHex:e.hex,vsize:e.vsize,version:e.version,locktime:e.locktime,ins:e.vin.map((t=>t.coinbase?{coinbase:t.coinbase,sequence:t.sequence}:{txId:t.txid,vout:t.vout,script:t.scriptSig.hex,sequence:t.sequence})),outs:e.vout.map((t=>{let e;return t.scriptPubKey.addresses?[e]=t.scriptPubKey.addresses:e=t.scriptPubKey.address?t.scriptPubKey.address:void 0,{address:e,script:t.scriptPubKey.hex,value:Math.round(1e8*t.value)}}))};var e}static async sendRawTransaction(t){const{result:e,error:r}=await Kt.sendRawTransaction(t);if(r)throw ot.error(r),new Error("Error sending transaction");return e}static getUtxos=async t=>(void 0===(await Kt.getaddressinfo(t)).result.timestamp&&(ot.info(`Importing address: ${t}`),await Kt.importaddress(t,!1)),(await Kt.listunspent(0,999999,[t])).result)}class Wt{static get=async t=>zt.getTransaction(t);static getRaw=async t=>zt.getBulkTransactions(t);static getRawJSON=async t=>zt.getRawTransactionsJSON(t);static sendRaw=async t=>zt.sendRawTransaction(t);static getUtxos=async t=>zt.getUtxos(t)}const Yt={protocol:z,user:D,pass:H,host:U,port:parseInt(K,10)};const Gt=new I(Yt);const Vt={};const Jt=JSON.parse(JSON.stringify(I.callspec));Object.keys(Jt).forEach((t=>{Jt[t.toLowerCase()]=Jt[t]}));const qt={str:t=>t.toString(),string:t=>t.toString(),int:t=>parseFloat(t),float:t=>parseFloat(t),bool:t=>!0===t||"1"===t||1===t||"true"===t||"true"===t.toString().toLowerCase(),obj:t=>"string"==typeof t?JSON.parse(t):t};try{Object.keys(I.prototype).forEach((t=>{if(t&&"function"==typeof I.prototype[t]){const e=t.toLowerCase();Vt[t]=T.promisify(I.prototype[t].bind(Gt)),Vt[e]=T.promisify(I.prototype[e].bind(Gt))}}))}catch(t){ot.error(`Error occurred while binding RPC methods: ${t.message}`)}const{PreparedStatement:Qt}=g;class Zt{static async listSentOutputs(t){const e=new Qt({name:`Output.listSentTxs.${Math.random()}`,text:'SELECT "Input"."spendingInput" AS "output", "Output"."satoshis" AS "amount"\n        FROM "Output" INNER JOIN "Input" ON "Output".rev = "Input"."outputSpent" \n        WHERE "Output"."address" = $1',values:[t]});return(await dt.any(e)).map((t=>({...t,amount:parseInt(t.amount,10)||0})))}static async listReceivedOutputs(t){const e=new Qt({name:`Output.listReceivedTxs.${Math.random()}`,text:'SELECT "Output"."rev" as "output", "Output"."satoshis" as "amount" FROM "Output" WHERE "address" = $1',values:[t]});return(await dt.any(e)).map((t=>({...t,amount:parseInt(t.amount,10)||0})))}static async listTxs(t){const e=new Qt({name:`Output.listTxs.${Math.random()}`,text:'WITH\n              -- List all txs sent from a given address\n              SENT AS (\n                SELECT split_part("Input"."spendingInput",\':\',1) as "txId", SUM("Output".satoshis) as "satoshis"\n                FROM "Output" INNER JOIN "Input" ON "Output".rev = "Input"."outputSpent"  \n                WHERE "Output".address = $1\n                GROUP BY split_part("Input"."spendingInput",\':\',1)\n              ),\n              -- List all tx received from a given address\n              RECEIVED AS (\n                SELECT SPLIT_PART("Output"."rev",\':\',1) as "txId", SUM("Output"."satoshis") as "satoshis" \n                FROM "Output" \n                WHERE "address" = $1\n                GROUP BY "txId"\n              )\n\n            SELECT\n              RECEIVED."txId", \n              coalesce(SENT."satoshis", 0) as "inputsSatoshis", \n              coalesce(RECEIVED."satoshis", 0) as "outputsSatoshis", \n              coalesce(RECEIVED."satoshis",0) - coalesce(SENT."satoshis",0) as "satoshis"\n            FROM\n              SENT RIGHT JOIN RECEIVED ON SENT."txId" = RECEIVED."txId";',values:[t]});const r=(await dt.any(e)).map((t=>({...t,inputsSatoshis:parseInt(t.inputsSatoshis,10)||0,outputsSatoshis:parseInt(t.outputsSatoshis,10)||0,satoshis:parseInt(t.satoshis,10)||0})));return{sentTxs:r.filter((t=>t.satoshis<0)).map((t=>({...t,satoshis:Math.abs(t.satoshis)}))),receivedTxs:r.filter((t=>t.satoshis>=0))}}static async select(t){const e=new Qt({name:`Output.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev" FROM "Output" WHERE "address" = $1',values:[t]});return dt.any(e)}static async insert(t){const e=t.flatMap((t=>[t.rev,t.address,t.satoshis,t.scriptPubKey,t.publicKeys]));for(;e.length;){const t=e.splice(0,1e4);const r=[];for(let e=1;e<=t.length;e+=5)r.push(`($${e}, $${e+1}, $${e+2}, $${e+3}, $${e+4})`);const n=r.join(",");const a=new Qt({name:`Output.insert.${Math.random()}`,text:`INSERT INTO "Output"("rev", "address", "satoshis", "scriptPubKey", "publicKeys") VALUES ${n}  ON CONFLICT DO NOTHING`,values:t});await dt.none(a)}}}class Xt{static async select(t){return Zt.select(t)}static async insert(t){return Zt.insert(t)}static async listSentOutputs(t){return Zt.listSentOutputs(t)}static async listReceivedOutputs(t){return Zt.listReceivedOutputs(t)}static async listTxs(t){return Zt.listTxs(t)}}class te{static insert=async t=>{const e=t.flatMap((t=>t.tx.outs.map(((e,r)=>{const{script:n}=e;let a;let s;try{a=l.fromOutputScript(n,ct(L,A))}catch(t){a=null}try{s=f.p2ms({output:n,network:ct(L,A)}).pubkeys.map((t=>t.toString("hex"))),s.some((t=>t.length>66))&&(s=null)}catch(t){s=null}const o=n.toString("hex");const i=Math.round(e.value);return{address:a,rev:`${t.txId}:${r}`,scriptPubKey:o,satoshis:i,publicKeys:s}}))));return Xt.insert(e)};static listSentOutputs=async t=>Xt.listSentOutputs(t);static listReceivedOutputs=async t=>Xt.listReceivedOutputs(t);static listTxs=async t=>Xt.listTxs(t)}const ee=t=>new Promise((e=>setTimeout(e,t)));const re=b(o);const ne=i.regtest;const{PreparedStatement:ae}=g;class se{static async select(t){const e=new ae({name:`Input.select.${Math.random()}`,text:'SELECT "outputSpent" FROM "Input" WHERE "outputSpent" = $1',values:[t]});return dt.any(e)}static async insert(t){const e=t.flatMap((t=>[t.outputSpent,t.spendingInput]));for(;e.length;){const t=e.splice(0,1e4);const r=[];for(let e=1;e<=t.length;e+=2)r.push(`($${e}, $${e+1})`);const n=r.join(",");const a=new ae({name:`Input.insert.${Math.random()}`,text:`INSERT INTO "Input"("outputSpent", "spendingInput") VALUES ${n} ON CONFLICT DO NOTHING`,values:t});await dt.none(a)}}static async count(t){const e=t.map((t=>t.outputSpent));const r=new ae({name:`Input.belong.${Math.random()}`,text:'SELECT count(*) FROM "Input" WHERE "outputSpent" LIKE ANY ($1)',values:[[e]]});const n=await dt.oneOrNone(r);return parseInt(n?.count,10)||0}}class oe{static async select(t){return se.select(t)}static async insert(t){return se.insert(t)}}class ie{static getNonCoinbaseRevs=t=>t.filter((t=>!d.isCoinbaseHash(t.input.hash))).map((({input:t,txId:e},r)=>{return{outputSpent:`${n=t.hash,c.reverseBuffer(Buffer.from(n)).toString("hex")}:${t.index}`,spendingInput:`${e}:${r}`};var n}));static insert=async t=>{const e=t.flatMap((t=>t.tx.ins.map((e=>({input:e,txId:t.txId})))));oe.insert(this.getNonCoinbaseRevs(e))}}let ce;try{ce=new O({chain:L,network:A,url:tt})}catch(t){ot.error(`Error creating computer, ${t.message}`),process.exit(1)}class ue{static rawTxSubscriber=async t=>{const e=t.toString("hex");if(ot.info(`ZMQ message { rawTx:${e} }`),"08"!==e.slice(10,12))try{const t=await ce.txFromHex({hex:e});await te.insert([t]),await ie.insert([t]),await Nt.add(t)}catch(t){ot.error(`Error parsing transaction ${t.message} ${t.stack}`)}};static checkSyncStatus=async()=>{const t=await S((async()=>{const t=await Kt.getBlockchainInfo();const e=(100*parseFloat(t.result.verificationprogress)).toFixed(4);const{blocks:r}=t.result;if(ot.info(`Zmq. Bitcoind { percentage:${e}%, blocks:${r} }`),parseFloat(t.result.verificationprogress)<=.7)throw new Error("Node not ready yet");return t}),{startingDelay:6e4,timeMultiple:1,numOfAttempts:8760});const e=(100*parseFloat(t.result.verificationprogress)).toFixed(4);const r=t.result.blocks;ot.info(`BCN reaches sync end...at { bitcoind.progress:${e}%, bitcoindSyncedHeight:${r} }`)};static createWallet=async()=>{try{await Kt.createwallet(Y,!1,!1,"",!1,!1)}catch(t){ot.error(`Wallet creation failed with error '${t.message}'`)}};static sub=async t=>{try{await this.createWallet(),"regtest"!==A&&await this.checkSyncStatus(),await(async()=>{if("regtest"===A){if(ot.info(`Node is starting for chain ${L} and network ${A}, \n\n. Starting Wallet setup.`),"LTC"===L){const{result:t}=await Kt.getBlockchainInfo();const e=t.blocks;if(e<ft){const{result:t}=await Kt.getNewAddress("","legacy");const r=ft-e-1;r&&await Kt.generateToAddress(r,t);const{result:n}=await Kt.getNewAddress("mweb","mweb");await Kt.sendToAddress(n,1),await Kt.generateToAddress(1,t),ot.info("MWEB setup is complete")}}if("BTC"===L){const{result:t}=await Kt.getNewAddress("","legacy");await Kt.generateToAddress(200,t),ot.info("Wallet setup is complete")}}})(),ot.info(`Bitcoin Computer Node ${lt} is ready. MAX_BLOCKCHAIN_HEIGHT: 2538171`);for await(const[,e]of t)await this.rawTxSubscriber(e)}catch(t){ot.error(`ZMQ subscription failed with error '${t.message}'`)}}}const{PreparedStatement:le}=g;class fe{static async select(t){const e=new le({name:`User.select.${Math.random()}`,text:'SELECT "publicKey", "clientTimestamp" FROM "User" WHERE "publicKey" = $1',values:[t]});const r=await dt.oneOrNone(e);return r?{publicKey:r.publicKey,clientTimestamp:parseInt(r.clientTimestamp,10)||0}:null}static async insert({publicKey:t,clientTimestamp:e}){const r=new le({name:`User.insert.${Math.random()}`,text:'INSERT INTO "User"("publicKey", "clientTimestamp") VALUES ($1, $2)',values:[t,e]});await dt.none(r)}static async update({publicKey:t,clientTimestamp:e}){const r=new le({name:`User.update.${Math.random()}`,text:'UPDATE "User" SET "clientTimestamp"=$1 WHERE "publicKey"=$2',values:[e,t]});await dt.none(r)}}class pe{static async select(t){return fe.select(t)}static async insert(t){return fe.insert(t)}static async update(t){return fe.update(t)}}const{ec:de}=$;const ve=new de("secp256k1");var he="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var me={exports:{}};var ye=me.exports={};ye.aton4=function(t){return t=t.split(/\./),(parseInt(t[0],10)<<24>>>0)+(parseInt(t[1],10)<<16>>>0)+(parseInt(t[2],10)<<8>>>0)+(parseInt(t[3],10)>>>0)},ye.aton6=function(t){var e=(t=t.replace(/"/g,"").split(/:/)).length-1;var r;if(""===t[e]&&(t[e]=0),e<7)for(t.length=8,r=e;r>=0&&""!==t[r];r--)t[7-e+r]=t[r];for(r=0;r<8;r++)t[r]?t[r]=parseInt(t[r],16):t[r]=0;var n=[];for(r=0;r<4;r++)n.push((t[2*r]<<16)+t[2*r+1]>>>0);return n},ye.cmp=function(t,e){return"number"==typeof t&&"number"==typeof e?t<e?-1:t>e?1:0:t instanceof Array&&e instanceof Array?this.cmp6(t,e):null},ye.cmp6=function(t,e){for(var r=0;r<2;r++){if(t[r]<e[r])return-1;if(t[r]>e[r])return 1}return 0},ye.isPrivateIP=function(t){return null!=(t=t.toString()).match(/^10\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/)||null!=t.match(/^192\.168\.([0-9]{1,3})\.([0-9]{1,3})/)||null!=t.match(/^172\.16\.([0-9]{1,3})\.([0-9]{1,3})/)||null!=t.match(/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})/)||null!=t.match(/^169\.254\.([0-9]{1,3})\.([0-9]{1,3})/)||null!=t.match(/^fc00:/)||null!=t.match(/^fe80:/)},ye.ntoa4=function(t){return((t=t.toString())>>>24&255)+"."+(t>>>16&255)+"."+(t>>>8&255)+"."+(255&t)},ye.ntoa6=function(t){var e="[";for(var r=0;r<t.length;r++)e+=(t[r]>>>16).toString(16)+":",e+=(65535&t[r]).toString(16)+":";return e.replace(/:$/,"]").replace(/:0+/g,":").replace(/::+/,"::")};var ge={};var we=E,Se=j,Ee={};function be(t){Ee[t].close()}ge.makeFsWatchFilter=function(t,e,r,n,a){var s=null;function o(){s=null,a()}"function"==typeof n&&(a=n,n=r,r=null),Ee[t]&&be(t),Ee[t]=we.watch(e,(function(t,a){if(a){var i=Se.join(e,a);r&&r!==a||we.exists(i,(function(t){t&&(null!==s&&(clearTimeout(s),s=null),s=setTimeout(o,n))}))}}))},ge.stopWatching=be;var Ie={exports:{}};var Te;Te=Ie,function(t){function e(t,e){e|=0;var r=Math.max(t.length-e,0);var n=Array(r);for(var a=0;a<r;a++)n[a]=t[e+a];return n}var r=function(t){var r=e(arguments,1);return function(){var n=e(arguments);return t.apply(null,r.concat(n))}};var n=function(t){return function(){var r=e(arguments);var n=r.pop();t.call(this,r,n)}};function a(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var s="function"==typeof setImmediate&&setImmediate;var o="object"==typeof process&&"function"==typeof process.nextTick;function i(t){setTimeout(t,0)}function c(t){return function(r){var n=e(arguments,1);t((function(){r.apply(null,n)}))}}var u=c(s?setImmediate:o?process.nextTick:i);function l(t){return n((function(e,r){var n;try{n=t.apply(this,e)}catch(t){return r(t)}a(n)&&"function"==typeof n.then?n.then((function(t){f(r,null,t)}),(function(t){f(r,t.message?t:new Error(t))})):r(null,n)}))}function f(t,e,r){try{t(e,r)}catch(t){u(p,t)}}function p(t){throw t}var d="function"==typeof Symbol;function v(t){return d&&"AsyncFunction"===t[Symbol.toStringTag]}function h(t){return v(t)?l(t):t}function m(t){return function(r){var a=e(arguments,1);var s=n((function(e,n){var a=this;return t(r,(function(t,r){h(t).apply(a,e.concat(r))}),n)}));return a.length?s.apply(this,a):s}}var y="object"==typeof he&&he&&he.Object===Object&&he;var g="object"==typeof self&&self&&self.Object===Object&&self;var w=y||g||Function("return this")();var S=w.Symbol;var E=Object.prototype;var b=E.hasOwnProperty;var I=E.toString;var T=S?S.toStringTag:void 0;var O=Object.prototype.toString;var $="[object Null]";var x="[object Undefined]";var j=S?S.toStringTag:void 0;function R(t){return null==t?void 0===t?x:$:j&&j in Object(t)?function(t){var e=b.call(t,T),r=t[T];try{t[T]=void 0;var n=!0}catch(t){}var a=I.call(t);return n&&(e?t[T]=r:delete t[T]),a}(t):function(t){return O.call(t)}(t)}var N="[object AsyncFunction]";var B="[object Function]";var L="[object GeneratorFunction]";var A="[object Proxy]";var P=9007199254740991;function M(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=P}function k(t){return null!=t&&M(t.length)&&!function(t){if(!a(t))return!1;var e=R(t);return e==B||e==L||e==N||e==A}(t)}var C={};function F(){}function _(t){return function(){if(null!==t){var e=t;t=null,e.apply(this,arguments)}}}var D="function"==typeof Symbol&&Symbol.iterator;var H=function(t){return D&&t[D]&&t[D]()};function U(t){return null!=t&&"object"==typeof t}function K(t){return U(t)&&"[object Arguments]"==R(t)}var z=Object.prototype;var W=z.hasOwnProperty;var Y=z.propertyIsEnumerable;var G=K(function(){return arguments}())?K:function(t){return U(t)&&W.call(t,"callee")&&!Y.call(t,"callee")};var V=Array.isArray;var J="object"==typeof t&&t&&!t.nodeType&&t;var q=J&&Te&&!Te.nodeType&&Te;var Q=q&&q.exports===J?w.Buffer:void 0;var Z=(Q?Q.isBuffer:void 0)||function(){return!1};var X=9007199254740991;var tt=/^(?:0|[1-9]\d*)$/;function et(t,e){var r=typeof t;return!!(e=null==e?X:e)&&("number"==r||"symbol"!=r&&tt.test(t))&&t>-1&&t%1==0&&t<e}var rt={};rt["[object Float32Array]"]=rt["[object Float64Array]"]=rt["[object Int8Array]"]=rt["[object Int16Array]"]=rt["[object Int32Array]"]=rt["[object Uint8Array]"]=rt["[object Uint8ClampedArray]"]=rt["[object Uint16Array]"]=rt["[object Uint32Array]"]=!0,rt["[object Arguments]"]=rt["[object Array]"]=rt["[object ArrayBuffer]"]=rt["[object Boolean]"]=rt["[object DataView]"]=rt["[object Date]"]=rt["[object Error]"]=rt["[object Function]"]=rt["[object Map]"]=rt["[object Number]"]=rt["[object Object]"]=rt["[object RegExp]"]=rt["[object Set]"]=rt["[object String]"]=rt["[object WeakMap]"]=!1;var nt="object"==typeof t&&t&&!t.nodeType&&t;var at=nt&&Te&&!Te.nodeType&&Te;var st=at&&at.exports===nt&&y.process;var ot=function(){try{return at&&at.require&&at.require("util").types||st&&st.binding&&st.binding("util")}catch(t){}}();var it=ot&&ot.isTypedArray;var ct=it?(ut=it,function(t){return ut(t)}):function(t){return U(t)&&M(t.length)&&!!rt[R(t)]};var ut;var lt=Object.prototype.hasOwnProperty;var ft=Object.prototype;var pt=function(t,e){return function(r){return t(e(r))}}(Object.keys,Object);var dt=Object.prototype.hasOwnProperty;function vt(t){return k(t)?function(t,e){var r=V(t),n=!r&&G(t),a=!r&&!n&&Z(t),s=!r&&!n&&!a&&ct(t),o=r||n||a||s,i=o?function(t,e){var r=-1,n=Array(t);for(;++r<t;)n[r]=e(r);return n}(t.length,String):[],c=i.length;for(var u in t)!lt.call(t,u)||o&&("length"==u||a&&("offset"==u||"parent"==u)||s&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||et(u,c))||i.push(u);return i}(t):function(t){if(r=(e=t)&&e.constructor,e!==("function"==typeof r&&r.prototype||ft))return pt(t);var e,r;var n=[];for(var a in Object(t))dt.call(t,a)&&"constructor"!=a&&n.push(a);return n}(t)}function ht(t){return function(){if(null===t)throw new Error("Callback was already called.");var e=t;t=null,e.apply(this,arguments)}}function mt(t){return function(e,r,n){if(n=_(n||F),t<=0||!e)return n(null);var a=function(t){if(k(t))return function(t){var e=-1;var r=t.length;return function(){return++e<r?{value:t[e],key:e}:null}}(t);var e=H(t);return e?function(t){var e=-1;return function(){var r=t.next();return r.done?null:(e++,{value:r.value,key:e})}}(e):(n=vt(r=t),a=-1,s=n.length,function t(){var e=n[++a];return"__proto__"===e?t():a<s?{value:r[e],key:e}:null});var r,n,a,s}(e);var s=!1;var o=0;var i=!1;function c(t,e){if(o-=1,t)s=!0,n(t);else{if(e===C||s&&o<=0)return s=!0,n(null);i||u()}}function u(){for(i=!0;o<t&&!s;){var e=a();if(null===e)return s=!0,void(o<=0&&n(null));o+=1,r(e.value,e.key,ht(c))}i=!1}u()}}function yt(t,e,r,n){mt(e)(t,h(r),n)}function gt(t,e){return function(r,n,a){return t(r,e,n,a)}}function wt(t,e,r){r=_(r||F);var n=0,a=0,s=t.length;function o(t,e){t?r(t):++a!==s&&e!==C||r(null)}for(0===s&&r(null);n<s;n++)e(t[n],n,ht(o))}var St=gt(yt,1/0);var Et=function(t,e,r){(k(t)?wt:St)(t,h(e),r)};function bt(t){return function(e,r,n){return t(Et,e,h(r),n)}}function It(t,e,r,n){n=n||F,e=e||[];var a=[];var s=0;var o=h(r);t(e,(function(t,e,r){var n=s++;o(t,(function(t,e){a[n]=e,r(t)}))}),(function(t){n(t,a)}))}var Tt=bt(It);var Ot=m(Tt);function $t(t){return function(e,r,n,a){return t(mt(r),e,h(n),a)}}var xt=$t(It);var jt=gt(xt,1);var Rt=m(jt);function Nt(t,e){var r=-1,n=null==t?0:t.length;for(;++r<n&&!1!==e(t[r],r,t););return t}var Bt=function(t,e,r){var n=-1,a=Object(t),s=r(t),o=s.length;for(;o--;){var i=s[++n];if(!1===e(a[i],i,a))break}return t};function Lt(t,e){return t&&Bt(t,e,vt)}function At(t){return t!=t}function Pt(t,e,r){return e==e?function(t,e,r){var n=r-1,a=t.length;for(;++n<a;)if(t[n]===e)return n;return-1}(t,e,r):function(t,e,r,n){var a=t.length,s=r+-1;for(;++s<a;)if(e(t[s],s,t))return s;return-1}(t,At,r)}var Mt=function(t,r,n){"function"==typeof r&&(n=r,r=null),n=_(n||F);var a=vt(t).length;if(!a)return n(null);r||(r=a);var s={};var o=0;var i=!1;var c=Object.create(null);var u=[];var l=[];var f={};function p(t,r){u.push((function(){!function(t,r){if(!i){var a=ht((function(r,a){if(o--,arguments.length>2&&(a=e(arguments,1)),r){var u={};Lt(s,(function(t,e){u[e]=t})),u[t]=a,i=!0,c=Object.create(null),n(r,u)}else s[t]=a,Nt(c[t]||[],(function(t){t()})),d()}));o++;var u=h(r[r.length-1]);r.length>1?u(s,a):u(a)}}(t,r)}))}function d(){if(0===u.length&&0===o)return n(null,s);for(;u.length&&o<r;)u.shift()()}function v(e){var r=[];return Lt(t,(function(t,n){V(t)&&Pt(t,e,0)>=0&&r.push(n)})),r}Lt(t,(function(e,r){if(!V(e))return p(r,[e]),void l.push(r);var n=e.slice(0,e.length-1);var a=n.length;if(0===a)return p(r,e),void l.push(r);f[r]=a,Nt(n,(function(s){if(!t[s])throw new Error("async.auto task `"+r+"` has a non-existent dependency `"+s+"` in "+n.join(", "));var o,i,u;i=function(){0==--a&&p(r,e)},(u=c[o=s])||(u=c[o]=[]),u.push(i)}))})),function(){var t=0;for(;l.length;)t++,Nt(v(l.pop()),(function(t){0==--f[t]&&l.push(t)}));if(t!==a)throw new Error("async.auto cannot execute tasks due to a recursive dependency")}(),d()};function kt(t,e){var r=-1,n=null==t?0:t.length,a=Array(n);for(;++r<n;)a[r]=e(t[r],r,t);return a}var Ct="[object Symbol]";var Ft=1/0;var _t=S?S.prototype:void 0;var Dt=_t?_t.toString:void 0;function Ht(t){if("string"==typeof t)return t;if(V(t))return kt(t,Ht)+"";if(function(t){return"symbol"==typeof t||U(t)&&R(t)==Ct}(t))return Dt?Dt.call(t):"";var e=t+"";return"0"==e&&1/t==-Ft?"-0":e}var Ut=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var Kt="\\ud800-\\udfff";var zt="["+Kt+"]";var Wt="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]";var Yt="\\ud83c[\\udffb-\\udfff]";var Gt="[^"+Kt+"]";var Vt="(?:\\ud83c[\\udde6-\\uddff]){2}";var Jt="[\\ud800-\\udbff][\\udc00-\\udfff]";var qt="(?:"+Wt+"|"+Yt+")?";var Qt="[\\ufe0e\\ufe0f]?";var Zt=Qt+qt+"(?:\\u200d(?:"+[Gt,Vt,Jt].join("|")+")"+Qt+qt+")*";var Xt="(?:"+[Gt+Wt+"?",Wt,Vt,Jt,zt].join("|")+")";var te=RegExp(Yt+"(?="+Yt+")|"+Xt+Zt,"g");function ee(t){return function(t){return Ut.test(t)}(t)?function(t){return t.match(te)||[]}(t):function(t){return t.split("")}(t)}var re=/^\s+|\s+$/g;var ne=/^(?:async\s+)?(function)?\s*[^\(]*\(\s*([^\)]*)\)/m;var ae=/,/;var se=/(=.+)?(\s*)$/;var oe=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;function ie(t,e){var r={};Lt(t,(function(t,e){var n;var a=v(t);var s=!a&&1===t.length||a&&0===t.length;if(V(t))n=t.slice(0,-1),t=t[t.length-1],r[e]=n.concat(n.length>0?o:t);else if(s)r[e]=t;else{if(n=function(t){return(t=(t=(t=t.toString().replace(oe,"")).match(ne)[2].replace(" ",""))?t.split(ae):[]).map((function(t){return function(t,e,r){if((t=null==(n=t)?"":Ht(n))&&void 0===e)return t.replace(re,"");var n;if(!t||!(e=Ht(e)))return t;var a=ee(t),s=ee(e);return(o=a,i=function(t,e){var r=-1,n=t.length;for(;++r<n&&Pt(e,t[r],0)>-1;);return r}(a,s),c=function(t,e){var r=t.length;for(;r--&&Pt(e,t[r],0)>-1;);return r}(a,s)+1,u=o.length,c=void 0===c?u:c,!i&&c>=u?o:function(t,e,r){var n=-1,a=t.length;e<0&&(e=-e>a?0:a+e),(r=r>a?a:r)<0&&(r+=a),a=e>r?0:r-e>>>0,e>>>=0;var s=Array(a);for(;++n<a;)s[n]=t[n+e];return s}(o,i,c)).join("");var o,i,c,u}(t.replace(se,""))}))}(t),0===t.length&&!a&&0===n.length)throw new Error("autoInject task functions require explicit parameters.");a||n.pop(),r[e]=n.concat(o)}function o(e,r){var a=kt(n,(function(t){return e[t]}));a.push(r),h(t).apply(null,a)}})),Mt(r,e)}function ce(){this.head=this.tail=null,this.length=0}function ue(t,e){t.length=1,t.head=t.tail=e}function le(t,e,r){if(null==e)e=1;else if(0===e)throw new Error("Concurrency must not be zero");var n=h(t);var a=0;var s=[];var o=!1;function i(t,e,r){if(null!=r&&"function"!=typeof r)throw new Error("task callback must be a function");if(f.started=!0,V(t)||(t=[t]),0===t.length&&f.idle())return u((function(){f.drain()}));for(var n=0,a=t.length;n<a;n++){var s={data:t[n],callback:r||F};e?f._tasks.unshift(s):f._tasks.push(s)}o||(o=!0,u((function(){o=!1,f.process()})))}function c(t){return function(e){a-=1;for(var r=0,n=t.length;r<n;r++){var o=t[r];var i=Pt(s,o,0);0===i?s.shift():i>0&&s.splice(i,1),o.callback.apply(o,arguments),null!=e&&f.error(e,o.data)}a<=f.concurrency-f.buffer&&f.unsaturated(),f.idle()&&f.drain(),f.process()}}var l=!1;var f={_tasks:new ce,concurrency:e,payload:r,saturated:F,unsaturated:F,buffer:e/4,empty:F,drain:F,error:F,started:!1,paused:!1,push:function(t,e){i(t,!1,e)},kill:function(){f.drain=F,f._tasks.empty()},unshift:function(t,e){i(t,!0,e)},remove:function(t){f._tasks.remove(t)},process:function(){if(!l){for(l=!0;!f.paused&&a<f.concurrency&&f._tasks.length;){var t=[],e=[];var r=f._tasks.length;f.payload&&(r=Math.min(r,f.payload));for(var o=0;o<r;o++){var i=f._tasks.shift();t.push(i),s.push(i),e.push(i.data)}a+=1,0===f._tasks.length&&f.empty(),a===f.concurrency&&f.saturated();var u=ht(c(t));n(e,u)}l=!1}},length:function(){return f._tasks.length},running:function(){return a},workersList:function(){return s},idle:function(){return f._tasks.length+a===0},pause:function(){f.paused=!0},resume:function(){!1!==f.paused&&(f.paused=!1,u(f.process))}};return f}function fe(t,e){return le(t,1,e)}ce.prototype.removeLink=function(t){return t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,t.prev=t.next=null,this.length-=1,t},ce.prototype.empty=function(){for(;this.head;)this.shift();return this},ce.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,t.next?t.next.prev=e:this.tail=e,t.next=e,this.length+=1},ce.prototype.insertBefore=function(t,e){e.prev=t.prev,e.next=t,t.prev?t.prev.next=e:this.head=e,t.prev=e,this.length+=1},ce.prototype.unshift=function(t){this.head?this.insertBefore(this.head,t):ue(this,t)},ce.prototype.push=function(t){this.tail?this.insertAfter(this.tail,t):ue(this,t)},ce.prototype.shift=function(){return this.head&&this.removeLink(this.head)},ce.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},ce.prototype.toArray=function(){var t=Array(this.length);var e=this.head;for(var r=0;r<this.length;r++)t[r]=e.data,e=e.next;return t},ce.prototype.remove=function(t){var e=this.head;for(;e;){var r=e.next;t(e)&&this.removeLink(e),e=r}return this};var pe=gt(yt,1);function de(t,e,r,n){n=_(n||F);var a=h(r);pe(t,(function(t,r,n){a(e,t,(function(t,r){e=r,n(t)}))}),(function(t){n(t,e)}))}function ve(){var t=kt(arguments,h);return function(){var r=e(arguments);var n=this;var a=r[r.length-1];"function"==typeof a?r.pop():a=F,de(t,r,(function(t,r,a){r.apply(n,t.concat((function(t){var r=e(arguments,1);a(t,r)})))}),(function(t,e){a.apply(n,[t].concat(e))}))}}var me=function(){return ve.apply(null,e(arguments).reverse())};var ye=Array.prototype.concat;var ge=function(t,r,n,a){a=a||F;var s=h(n);xt(t,r,(function(t,r){s(t,(function(t){return t?r(t):r(null,e(arguments,1))}))}),(function(t,e){var r=[];for(var n=0;n<e.length;n++)e[n]&&(r=ye.apply(r,e[n]));return a(t,r)}))};var we=gt(ge,1/0);var Se=gt(ge,1);var Ee=function(){var t=e(arguments);var r=[null].concat(t);return function(){return arguments[arguments.length-1].apply(this,r)}};function be(t){return t}function Ie(t,e){return function(r,n,a,s){s=s||F;var o=!1;var i;r(n,(function(r,n,s){a(r,(function(n,a){n?s(n):t(a)&&!i?(o=!0,i=e(!0,r),s(null,C)):s()}))}),(function(t){t?s(t):s(null,o?i:e(!1))}))}}function Oe(t,e){return e}var $e=bt(Ie(be,Oe));var xe=$t(Ie(be,Oe));var je=gt(xe,1);function Re(t){return function(r){var n=e(arguments,1);n.push((function(r){var n=e(arguments,1);"object"==typeof console&&(r?console.error&&console.error(r):console[t]&&Nt(n,(function(e){console[t](e)})))})),h(r).apply(null,n)}}var Ne=Re("dir");function Be(t,r,n){n=ht(n||F);var a=h(t);var s=h(r);function o(t){if(t)return n(t);var r=e(arguments,1);r.push(i),s.apply(this,r)}function i(t,e){return t?n(t):e?void a(o):n(null)}i(null,!0)}function Le(t,r,n){n=ht(n||F);var a=h(t);var s=function(t){if(t)return n(t);var o=e(arguments,1);if(r.apply(this,o))return a(s);n.apply(null,[null].concat(o))};a(s)}function Ae(t,e,r){Le(t,(function(){return!e.apply(this,arguments)}),r)}function Pe(t,e,r){r=ht(r||F);var n=h(e);var a=h(t);function s(t){if(t)return r(t);a(o)}function o(t,e){return t?r(t):e?void n(s):r(null)}a(o)}function Me(t){return function(e,r,n){return t(e,n)}}function ke(t,e,r){Et(t,Me(h(e)),r)}function Ce(t,e,r,n){mt(e)(t,Me(h(r)),n)}var Fe=gt(Ce,1);function _e(t){return v(t)?t:n((function(e,r){var n=!0;e.push((function(){var t=arguments;n?u((function(){r.apply(null,t)})):r.apply(null,t)})),t.apply(this,e),n=!1}))}function De(t){return!t}var He=bt(Ie(De,De));var Ue=$t(Ie(De,De));var Ke=gt(Ue,1);function ze(t){return function(e){return null==e?void 0:e[t]}}function We(t,e,r,n){var a=new Array(e.length);t(e,(function(t,e,n){r(t,(function(t,r){a[e]=!!r,n(t)}))}),(function(t){if(t)return n(t);var r=[];for(var s=0;s<e.length;s++)a[s]&&r.push(e[s]);n(null,r)}))}function Ye(t,e,r,n){var a=[];t(e,(function(t,e,n){r(t,(function(r,s){r?n(r):(s&&a.push({index:e,value:t}),n())}))}),(function(t){t?n(t):n(null,kt(a.sort((function(t,e){return t.index-e.index})),ze("value")))}))}function Ge(t,e,r,n){(k(e)?We:Ye)(t,e,h(r),n||F)}var Ve=bt(Ge);var Je=$t(Ge);var qe=gt(Je,1);function Qe(t,e){var r=ht(e||F);var n=h(_e(t));!function t(e){if(e)return r(e);n(t)}()}var Ze=function(t,e,r,n){n=n||F;var a=h(r);xt(t,e,(function(t,e){a(t,(function(r,n){return r?e(r):e(null,{key:n,val:t})}))}),(function(t,e){var r={};var a=Object.prototype.hasOwnProperty;for(var s=0;s<e.length;s++)if(e[s]){var o=e[s].key;var i=e[s].val;a.call(r,o)?r[o].push(i):r[o]=[i]}return n(t,r)}))};var Xe=gt(Ze,1/0);var tr=gt(Ze,1);var er=Re("log");function rr(t,e,r,n){n=_(n||F);var a={};var s=h(r);yt(t,e,(function(t,e,r){s(t,e,(function(t,n){if(t)return r(t);a[e]=n,r()}))}),(function(t){n(t,a)}))}var nr=gt(rr,1/0);var ar=gt(rr,1);function sr(t,e){return e in t}function or(t,r){var a=Object.create(null);var s=Object.create(null);r=r||be;var o=h(t);var i=n((function(t,n){var i=r.apply(null,t);sr(a,i)?u((function(){n.apply(null,a[i])})):sr(s,i)?s[i].push(n):(s[i]=[n],o.apply(null,t.concat((function(){var t=e(arguments);a[i]=t;var r=s[i];delete s[i];for(var n=0,o=r.length;n<o;n++)r[n].apply(null,t)}))))}));return i.memo=a,i.unmemoized=t,i}var ir=c(o?process.nextTick:s?setImmediate:i);function cr(t,r,n){n=n||F;var a=k(r)?[]:{};t(r,(function(t,r,n){h(t)((function(t,s){arguments.length>2&&(s=e(arguments,1)),a[r]=s,n(t)}))}),(function(t){n(t,a)}))}function ur(t,e){cr(Et,t,e)}function lr(t,e,r){cr(mt(e),t,r)}var fr=function(t,e){var r=h(t);return le((function(t,e){r(t[0],e)}),e,1)};var pr=function(t,e){var r=fr(t,e);return r.push=function(t,e,n){if(null==n&&(n=F),"function"!=typeof n)throw new Error("task callback must be a function");if(r.started=!0,V(t)||(t=[t]),0===t.length)return u((function(){r.drain()}));e=e||0;var a=r._tasks.head;for(;a&&e>=a.priority;)a=a.next;for(var s=0,o=t.length;s<o;s++){var i={data:t[s],priority:e,callback:n};a?r._tasks.insertBefore(a,i):r._tasks.push(i)}u(r.process)},delete r.unshift,r};function dr(t,e){if(e=_(e||F),!V(t))return e(new TypeError("First argument to race must be an array of functions"));if(!t.length)return e();for(var r=0,n=t.length;r<n;r++)h(t[r])(e)}function vr(t,r,n,a){de(e(t).reverse(),r,n,a)}function hr(t){var r=h(t);return n((function(t,n){return t.push((function(t,r){var a;t?n(null,{error:t}):(a=arguments.length<=2?r:e(arguments,1),n(null,{value:a}))})),r.apply(this,t)}))}function mr(t){var e;return V(t)?e=kt(t,hr):(e={},Lt(t,(function(t,r){e[r]=hr.call(this,t)}))),e}function yr(t,e,r,n){Ge(t,e,(function(t,e){r(t,(function(t,r){e(t,!r)}))}),n)}var gr=bt(yr);var wr=$t(yr);var Sr=gt(wr,1);function Er(t){return function(){return t}}function br(t,e,r){var n={times:5,intervalFunc:Er(0)};if(arguments.length<3&&"function"==typeof t?(r=e||F,e=t):(function(t,e){if("object"==typeof e)t.times=+e.times||5,t.intervalFunc="function"==typeof e.interval?e.interval:Er(+e.interval||0),t.errorFilter=e.errorFilter;else{if("number"!=typeof e&&"string"!=typeof e)throw new Error("Invalid arguments for async.retry");t.times=+e||5}}(n,t),r=r||F),"function"!=typeof e)throw new Error("Invalid arguments for async.retry");var a=h(e);var s=1;!function t(){a((function(e){e&&s++<n.times&&("function"!=typeof n.errorFilter||n.errorFilter(e))?setTimeout(t,n.intervalFunc(s)):r.apply(null,arguments)}))}()}var Ir=function(t,e){e||(e=t,t=null);var r=h(e);return n((function(e,n){function a(t){r.apply(null,e.concat(t))}t?br(t,a,n):br(a,n)}))};function Tr(t,e){cr(pe,t,e)}var Or=bt(Ie(Boolean,be));var $r=$t(Ie(Boolean,be));var xr=gt($r,1);function jr(t,e,r){var n=h(e);function a(t,e){var r=t.criteria,n=e.criteria;return r<n?-1:r>n?1:0}Tt(t,(function(t,e){n(t,(function(r,n){if(r)return e(r);e(null,{value:t,criteria:n})}))}),(function(t,e){if(t)return r(t);r(null,kt(e.sort(a),ze("value")))}))}function Rr(t,e,r){var a=h(t);return n((function(n,s){var o=!1;var i;n.push((function(){o||(s.apply(null,arguments),clearTimeout(i))})),i=setTimeout((function(){var e=t.name||"anonymous";var n=new Error('Callback function "'+e+'" timed out.');n.code="ETIMEDOUT",r&&(n.info=r),o=!0,s(n)}),e),a.apply(null,n)}))}var Nr=Math.ceil;var Br=Math.max;function Lr(t,e,r,n){var a=h(r);xt(function(t,e,r,n){var a=-1,s=Br(Nr((e-t)/1),0),o=Array(s);for(;s--;)o[++a]=t,t+=1;return o}(0,t),e,a,n)}var Ar=gt(Lr,1/0);var Pr=gt(Lr,1);function Mr(t,e,r,n){arguments.length<=3&&(n=r,r=e,e=V(t)?[]:{}),n=_(n||F);var a=h(r);Et(t,(function(t,r,n){a(e,t,r,n)}),(function(t){n(t,e)}))}function kr(t,r){var n=null;var a;r=r||F,Fe(t,(function(t,r){h(t)((function(t,s){a=arguments.length>2?e(arguments,1):s,n=t,r(!t)}))}),(function(){r(n,a)}))}function Cr(t){return function(){return(t.unmemoized||t).apply(null,arguments)}}function Fr(t,r,n){n=ht(n||F);var a=h(r);if(!t())return n(null);var s=function(r){if(r)return n(r);if(t())return a(s);var o=e(arguments,1);n.apply(null,[null].concat(o))};a(s)}function _r(t,e,r){Fr((function(){return!t.apply(this,arguments)}),e,r)}var Dr=function(t,r){if(r=_(r||F),!V(t))return r(new Error("First argument to waterfall must be an array of functions"));if(!t.length)return r();var n=0;function a(e){var r=h(t[n++]);e.push(ht(s)),r.apply(null,e)}function s(s){if(s||n===t.length)return r.apply(null,arguments);a(e(arguments,1))}a([])};var Hr={apply:r,applyEach:Ot,applyEachSeries:Rt,asyncify:l,auto:Mt,autoInject:ie,cargo:fe,compose:me,concat:we,concatLimit:ge,concatSeries:Se,constant:Ee,detect:$e,detectLimit:xe,detectSeries:je,dir:Ne,doDuring:Be,doUntil:Ae,doWhilst:Le,during:Pe,each:ke,eachLimit:Ce,eachOf:Et,eachOfLimit:yt,eachOfSeries:pe,eachSeries:Fe,ensureAsync:_e,every:He,everyLimit:Ue,everySeries:Ke,filter:Ve,filterLimit:Je,filterSeries:qe,forever:Qe,groupBy:Xe,groupByLimit:Ze,groupBySeries:tr,log:er,map:Tt,mapLimit:xt,mapSeries:jt,mapValues:nr,mapValuesLimit:rr,mapValuesSeries:ar,memoize:or,nextTick:ir,parallel:ur,parallelLimit:lr,priorityQueue:pr,queue:fr,race:dr,reduce:de,reduceRight:vr,reflect:hr,reflectAll:mr,reject:gr,rejectLimit:wr,rejectSeries:Sr,retry:br,retryable:Ir,seq:ve,series:Tr,setImmediate:u,some:Or,someLimit:$r,someSeries:xr,sortBy:jr,timeout:Rr,times:Ar,timesLimit:Lr,timesSeries:Pr,transform:Mr,tryEach:kr,unmemoize:Cr,until:_r,waterfall:Dr,whilst:Fr,all:He,allLimit:Ue,allSeries:Ke,any:Or,anyLimit:$r,anySeries:xr,find:$e,findLimit:xe,findSeries:je,forEach:ke,forEachSeries:Fe,forEachLimit:Ce,forEachOf:Et,forEachOfSeries:pe,forEachOfLimit:yt,inject:de,foldl:de,foldr:vr,select:Ve,selectLimit:Je,selectSeries:qe,wrapSync:l};t.default=Hr,t.apply=r,t.applyEach=Ot,t.applyEachSeries=Rt,t.asyncify=l,t.auto=Mt,t.autoInject=ie,t.cargo=fe,t.compose=me,t.concat=we,t.concatLimit=ge,t.concatSeries=Se,t.constant=Ee,t.detect=$e,t.detectLimit=xe,t.detectSeries=je,t.dir=Ne,t.doDuring=Be,t.doUntil=Ae,t.doWhilst=Le,t.during=Pe,t.each=ke,t.eachLimit=Ce,t.eachOf=Et,t.eachOfLimit=yt,t.eachOfSeries=pe,t.eachSeries=Fe,t.ensureAsync=_e,t.every=He,t.everyLimit=Ue,t.everySeries=Ke,t.filter=Ve,t.filterLimit=Je,t.filterSeries=qe,t.forever=Qe,t.groupBy=Xe,t.groupByLimit=Ze,t.groupBySeries=tr,t.log=er,t.map=Tt,t.mapLimit=xt,t.mapSeries=jt,t.mapValues=nr,t.mapValuesLimit=rr,t.mapValuesSeries=ar,t.memoize=or,t.nextTick=ir,t.parallel=ur,t.parallelLimit=lr,t.priorityQueue=pr,t.queue=fr,t.race=dr,t.reduce=de,t.reduceRight=vr,t.reflect=hr,t.reflectAll=mr,t.reject=gr,t.rejectLimit=wr,t.rejectSeries=Sr,t.retry=br,t.retryable=Ir,t.seq=ve,t.series=Tr,t.setImmediate=u,t.some=Or,t.someLimit=$r,t.someSeries=xr,t.sortBy=jr,t.timeout=Rr,t.times=Ar,t.timesLimit=Lr,t.timesSeries=Pr,t.transform=Mr,t.tryEach=kr,t.unmemoize=Cr,t.until=_r,t.waterfall=Dr,t.whilst=Fr,t.all=He,t.allLimit=Ue,t.allSeries=Ke,t.any=Or,t.anyLimit=$r,t.anySeries=xr,t.find=$e,t.findLimit=xe,t.findSeries=je,t.forEach=ke,t.forEachSeries=Fe,t.forEachLimit=Ce,t.forEachOf=Et,t.forEachOfSeries=pe,t.forEachOfLimit=yt,t.inject=de,t.foldl=de,t.foldr=vr,t.select=Ve,t.selectLimit=Je,t.selectSeries=qe,t.wrapSync=l,Object.defineProperty(t,"__esModule",{value:!0})}(Ie.exports);var Oe=E;var $e=B;var xe=j;Oe.existsSync=Oe.existsSync||xe.existsSync;var je=me.exports;var Re=Ie.exports;var Ne=xe.resolve(__dirname,he.geodatadir||process.env.GEODATADIR||"../data/");var Be={city:xe.join(Ne,"geoip-city.dat"),city6:xe.join(Ne,"geoip-city6.dat"),cityNames:xe.join(Ne,"geoip-city-names.dat"),country:xe.join(Ne,"geoip-country.dat"),country6:xe.join(Ne,"geoip-country6.dat")};var Le=[[je.aton4("10.0.0.0"),je.aton4("10.255.255.255")],[je.aton4("172.16.0.0"),je.aton4("172.31.255.255")],[je.aton4("192.168.0.0"),je.aton4("192.168.255.255")]];var Ae={firstIP:null,lastIP:null,lastLine:0,locationBuffer:null,locationRecordSize:88,mainBuffer:null,recordSize:24};var Pe={firstIP:null,lastIP:null,lastLine:0,mainBuffer:null,recordSize:48};var Me=JSON.parse(JSON.stringify(Ae));var ke=JSON.parse(JSON.stringify(Pe));function Ce(t){var e=0;var r=Me.lastIP;var n=Me.lastLine;var a=Me.firstIP;var s;var o;var i=Me.mainBuffer;var c=Me.locationBuffer;var u=Le;var l=Me.recordSize;var f=Me.locationRecordSize;var p;var d={range:"",country:"",region:"",eu:"",timezone:"",city:"",ll:[null,null]};if(t>Me.lastIP||t<Me.firstIP)return null;for(p=0;p<u.length;p++)if(t>=u[p][0]&&t<=u[p][1])return null;for(;;){if(s=Math.round((n-e)/2)+e,r=i.readUInt32BE(s*l),a=i.readUInt32BE(s*l+4),r<=t&&a>=t)return d.range=[r,a],10===l?d.country=i.toString("utf8",s*l+8,s*l+10):-1>>>0>(o=i.readUInt32BE(s*l+8))&&(d.country=c.toString("utf8",o*f+0,o*f+2).replace(/\u0000.*/,""),d.region=c.toString("utf8",o*f+2,o*f+5).replace(/\u0000.*/,""),d.metro=c.readInt32BE(o*f+5),d.ll[0]=i.readInt32BE(s*l+12)/1e4,d.ll[1]=i.readInt32BE(s*l+16)/1e4,d.area=i.readUInt32BE(s*l+20),d.eu=c.toString("utf8",o*f+9,o*f+10).replace(/\u0000.*/,""),d.timezone=c.toString("utf8",o*f+10,o*f+42).replace(/\u0000.*/,""),d.city=c.toString("utf8",o*f+42,o*f+f).replace(/\u0000.*/,"")),d;if(e===n)return null;e===n-1?s===e?e=n:n=e:r>t?n=s:a<t&&(e=s)}}je.cmp,function(t){var e;var r;var n=JSON.parse(JSON.stringify(Ae));if("function"==typeof arguments[0])Re.series([function(t){Re.series([function(t){Oe.open(Be.cityNames,"r",(function(r,n){e=n,t(r)}))},function(t){Oe.fstat(e,(function(e,a){r=a.size,n.locationBuffer=Buffer.alloc(r),t(e)}))},function(t){Oe.read(e,n.locationBuffer,0,r,0,t)},function(t){Oe.close(e,t)},function(t){Oe.open(Be.city,"r",(function(r,n){e=n,t(r)}))},function(t){Oe.fstat(e,(function(e,n){r=n.size,t(e)}))}],(function(a){if(a){if("ENOENT"!==a.code&&"EBADF"!==a.code)throw a;Oe.open(Be.country,"r",(function(a,s){a?t(a):(e=s,Oe.fstat(e,(function(e,a){r=a.size,n.recordSize=10,t()})))}))}else t()}))},function(){n.mainBuffer=Buffer.alloc(r),Re.series([function(t){Oe.read(e,n.mainBuffer,0,r,0,t)},function(t){Oe.close(e,t)}],(function(e){e||(n.lastLine=r/n.recordSize-1,n.lastIP=n.mainBuffer.readUInt32BE(n.lastLine*n.recordSize+4),n.firstIP=n.mainBuffer.readUInt32BE(0),Me=n),t(e)}))}]);else{try{if(e=Oe.openSync(Be.cityNames,"r"),0===(r=Oe.fstatSync(e).size))throw{code:"EMPTY_FILE"};Me.locationBuffer=Buffer.alloc(r),Oe.readSync(e,Me.locationBuffer,0,r,0),Oe.closeSync(e),e=Oe.openSync(Be.city,"r"),r=Oe.fstatSync(e).size}catch(t){if("ENOENT"!==t.code&&"EBADF"!==t.code&&"EMPTY_FILE"!==t.code)throw t;e=Oe.openSync(Be.country,"r"),r=Oe.fstatSync(e).size,Me.recordSize=10}Me.mainBuffer=Buffer.alloc(r),Oe.readSync(e,Me.mainBuffer,0,r,0),Oe.closeSync(e),Me.lastLine=r/Me.recordSize-1,Me.lastIP=Me.mainBuffer.readUInt32BE(Me.lastLine*Me.recordSize+4),Me.firstIP=Me.mainBuffer.readUInt32BE(0)}}(),function(t){var e;var r;var n=JSON.parse(JSON.stringify(Pe));if("function"==typeof arguments[0])Re.series([function(t){Re.series([function(t){Oe.open(Be.city6,"r",(function(r,n){e=n,t(r)}))},function(t){Oe.fstat(e,(function(e,n){r=n.size,t(e)}))}],(function(a){if(a){if("ENOENT"!==a.code&&"EBADF"!==a.code)throw a;Oe.open(Be.country6,"r",(function(a,s){a?t(a):(e=s,Oe.fstat(e,(function(e,a){r=a.size,n.recordSize=34,t()})))}))}else t()}))},function(){n.mainBuffer=Buffer.alloc(r),Re.series([function(t){Oe.read(e,n.mainBuffer,0,r,0,t)},function(t){Oe.close(e,t)}],(function(e){e||(n.lastLine=r/n.recordSize-1,ke=n),t(e)}))}]);else{try{if(e=Oe.openSync(Be.city6,"r"),0===(r=Oe.fstatSync(e).size))throw{code:"EMPTY_FILE"}}catch(t){if("ENOENT"!==t.code&&"EBADF"!==t.code&&"EMPTY_FILE"!==t.code)throw t;e=Oe.openSync(Be.country6,"r"),r=Oe.fstatSync(e).size,ke.recordSize=34}ke.mainBuffer=Buffer.alloc(r),Oe.readSync(e,ke.mainBuffer,0,r,0),Oe.closeSync(e),ke.lastLine=r/ke.recordSize-1}}();const Fe=r();const _e=new class{configFile;loaded=!1;load=()=>{try{const t=it()?"bcn.test.config.json":"bcn.config.json";const e=R(N(import.meta.url));this.configFile=E.readFileSync(j.join(e,"..","..",t)),this.loaded=!0}catch(t){if(t.message.includes("ENOENT: no such file or directory"))return void(this.loaded=!0);throw ot.error(`Access-list failed with error '${t.message}'`),t}};middleware=({url:t},e,r)=>{if(void 0!==e.locals.authToken)if(this.loaded||(ot.warn("Access-list failed with error 'AccessList not loaded.'. Loading now."),this.load()),void 0!==this.configFile)try{const{blacklist:t,whitelist:n}=JSON.parse(this.configFile.toString());if(t&&n)return void e.status(403).json({error:"Cannot enforce blacklist and whitelist at the same time."});const{publicKey:a}=e.locals.authToken;if(n&&!n.includes(a)||t&&t.includes(a))return void e.status(403).json({error:`Public key ${a} is not allowed.`});r()}catch(r){ot.error(`Authorization failed at ${t} with error: '${r.message}'`),e.status(403).json({error:r.message})}else r();else r()}};let De;v(o);try{De=n.createServer(Fe)}catch(t){throw ot.error(`Starting server failed with error '${t.message}'`),t}if(ot.info(`Server listening on port ${P}`),Fe.use(e()),Z.length)try{Fe.use((async function(t,e,r){try{const n=t.ip||t.headers["x-forwarded-for"];if(n){const t=function(t){if(!t)return null;if("number"==typeof t)return Ce(t);if(4===$e.isIP(t))return Ce(je.aton4(t));if(6===$e.isIP(t)){var e=function(t){var e=t.toUpperCase();var r=["0:0:0:0:0:FFFF:","::FFFF:"];for(var n=0;n<r.length;n++){var a=r[n];if(0==e.indexOf(a))return e.substring(a.length)}return null}(t);return e?Ce(je.aton4(e)):function(t){var e=ke.mainBuffer;var r=ke.recordSize;var n=Me.locationBuffer;var a=Me.locationRecordSize;var s={range:"",country:"",region:"",city:"",ll:[0,0]};function o(t,n){var a=0;var s=[];for(a=0;a<2;a++)s.push(e.readUInt32BE(t*r+16*n+4*a));return s}ke.lastIP=o(ke.lastLine,1),ke.firstIP=o(0,0);var i=0;var c=ke.lastIP;var u=ke.lastLine;var l=ke.firstIP;var f;var p;if(je.cmp6(t,ke.lastIP)>0||je.cmp6(t,ke.firstIP)<0)return null;for(;;){if(c=o(f=Math.round((u-i)/2)+i,0),l=o(f,1),je.cmp6(c,t)<=0&&je.cmp6(l,t)>=0)return 34===r?s.country=e.toString("utf8",f*r+32,f*r+34).replace(/\u0000.*/,""):-1>>>0>(p=e.readUInt32BE(f*r+32))&&(s.country=n.toString("utf8",p*a+0,p*a+2).replace(/\u0000.*/,""),s.region=n.toString("utf8",p*a+2,p*a+5).replace(/\u0000.*/,""),s.metro=n.readInt32BE(p*a+5),s.ll[0]=e.readInt32BE(f*r+36)/1e4,s.ll[1]=e.readInt32BE(f*r+40)/1e4,s.area=e.readUInt32BE(f*r+44),s.eu=n.toString("utf8",p*a+9,p*a+10).replace(/\u0000.*/,""),s.timezone=n.toString("utf8",p*a+10,p*a+42).replace(/\u0000.*/,""),s.city=n.toString("utf8",p*a+42,p*a+a).replace(/\u0000.*/,"")),s;if(i===u)return null;i===u-1?f===i?i=u:u=i:je.cmp6(c,t)>0?u=f:je.cmp6(l,t)<0&&(i=f)}}(je.aton6(t))}return null}(n);if(t&&(Z||"").split(",").includes(t.country))return void e.status(401).json({error:`We're not serving in ${t.country} at the moment.`})}r()}catch(t){ot.error(`Request failed with error '${t.message}'`),e.status(401).json({error:t.message})}}))}catch(t){ot.error(`Failed to load filter-ips middleware: ${t.message}`)}if("dev"!==et){const t=s({windowMs:9e5,max:300,standardHeaders:!0,legacyHeaders:!1});Fe.use(t)}Fe.use(t.json({limit:"100mb"})),Fe.use(t.urlencoded({limit:"100mb",extended:!0})),Fe.get("/",((t,e)=>e.status(200).send(`\n        <h2>Bitcoin Computer Node</h2>\n        <b>Status</b>: Healthy <br />\n        <b>Version</b>: ${lt} <br />\n        <b>Chain</b>: ${L} <br />\n        <b>Network</b>: ${A}\n    `))),_e.loaded&&(Fe.use((async(t,e,r)=>{try{const n=t.get("Authentication");if(!n){const{method:r,url:n}=t;const a=`Auth failed with error 'no Authentication key provided' ${r} ${t.get("Host")} ${n}`;return ot.error(a),void e.status(401).json({error:a})}const a=(t=>{const e=t.split(" ");if(2!==e.length||"Bearer"!==e[0])throw new Error("Authentication header is invalid.");const r=Buffer.from(e[1],"base64").toString().split(":");if(3!==r.length)throw new Error;return{signature:r[0],publicKey:r[1],timestamp:parseInt(r[2],10)}})(n);const{signature:s,publicKey:o,timestamp:i}=a;if(Date.now()-i>18e4)return void e.status(401).json({error:"Signature is too old."});const c=x.sha256().update(tt+i).digest("hex");if(!ve.keyFromPublic(o,"hex").verify(c,s)){const t="The origin and public key pair doesn't match the signature.";return void e.status(401).json({error:t})}const u=await pe.select(o);if(u){if(u.clientTimestamp>=i)return void e.status(401).json({error:"Please use a fresh authentication token."});await pe.update({publicKey:o,clientTimestamp:i})}else await pe.insert({publicKey:o,clientTimestamp:i});e.locals.authToken=a,r()}catch(t){ot.error(`Auth failed with error '${t.message}'`),e.status(401).json({error:t.message})}})),Fe.use(_e.middleware));const He=(()=>{const t=r.Router();return t.get("/wallet/:address/utxos",(async({params:t,url:e},r)=>{try{const{address:e}=t;r.status(200).json(await Et.select(e))}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.get("/wallet/:address/sent-outputs",(async({params:t,url:e},r)=>{try{const{address:e}=t;r.status(200).json(await te.listSentOutputs(e))}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.get("/wallet/:address/received-outputs",(async({params:t,url:e},r)=>{try{const{address:e}=t;r.status(200).json(await te.listReceivedOutputs(e))}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.get("/wallet/:address/list-txs",(async({params:t,url:e},r)=>{try{const{address:e}=t;r.status(200).json(await te.listTxs(e))}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.get("/non-standard-utxos",(async(t,e)=>{try{const r=new URLSearchParams(t.url.split("?")[1]);const n={mod:r.get("mod"),publicKey:r.get("publicKey"),hash:r.get("hash"),limit:r.get("limit"),order:r.get("order"),offset:r.get("offset"),ids:JSON.parse(r.get("ids"))};const a=await Nt.query(n);e.status(200).json(a)}catch(r){ot.error(`GET ${t.url} failed with error '${r.messages}'`),e.status(404).json({error:r.message})}})),t.get("/address/:address/balance",(async({params:t,url:e},r)=>{try{const{address:e}=t;r.status(200).json(await Et.getBalance(e))}catch(t){ot.error(`GET ${e} failed with error '${t.message||t}'`),r.status(404).json({error:t.message})}})),t.post("/tx/bulk",(async({body:{txIds:t},url:e},r)=>{try{if(void 0===t||0===t.length)return void r.status(500).json({error:"Missing input txIds."});const e=await Wt.getRaw(t);e?r.status(200).json(e):r.status(404).json({error:"Not found"})}catch(t){ot.error(`POST ${e} failed with error '${t.message}'`),r.status(500).json({error:t.message})}})),t.post("/tx/post",(async({body:{hex:t},url:e},r)=>{try{if(!t)return void r.status(500).json({error:"Missing input hex."});const e=await Wt.sendRaw(t);e?r.status(200).json(e):r.status(404).json({error:"Error Occured"})}catch(n){ot.error(`POST ${e} failed with error '${n.message}\ntxHex: ${t}`),r.status(500).json({error:n.message})}})),t.get("/mine",(async({query:{count:t},url:e},r)=>{try{const{result:e}=await Vt.getnewaddress();if("string"!=typeof t)throw new Error("Please provide appropriate count");return await Vt.generatetoaddress(parseInt(t,10)||1,e),r.status(200).json({success:!0})}catch(t){return ot.error(`POST ${e} failed with error '${t.message}'`),r.status(500).json({error:t.message})}})),t.get("/:id/height",(async({params:{id:t},url:e},r)=>{try{let e=t;if("best"===t){const{result:t}=await Vt.getbestblockhash();e=t}const{result:n}=await Vt.getblockheader(e,!0);return r.status(200).json({height:n.height})}catch(t){return ot.error(`POST ${e} failed with error '${t.message}'`),r.status(500).json({error:t.message})}})),t.post("/faucet",(async({body:{address:t,value:e},url:r},n)=>{try{const r=parseInt(e,10)/1e8;const{result:a}=await Vt.sendtoaddress(t,r);await Vt.generateToAddress(1,"mvFeNF9DAR7WMuCpBPbKuTtheihLyxzj8i");const{result:s}=await Vt.getrawtransaction(a,1);const o=s.vout.findIndex((t=>1e8*t.value===parseInt(e,10)));return n.status(200).json({txId:a,vout:o,height:-1,satoshis:e})}catch(t){return ot.error(`POST ${r} failed with error '${t.message}'`),n.status(500).json({error:t.message})}})),t.post("/faucetScript",(async({body:{script:t,value:e},url:r},n)=>{try{const r=re.makeRandom({network:ne});const a=f.p2pkh({pubkey:r.publicKey,network:ne});const{address:s}=a;const o=(await Vt.sendtoaddress(s,2*parseInt(e,10)/1e8,"","")).result;let i;let c=10;for(;!i;)if(i=(await Et.select(s)).filter((t=>t.txId===o))[0],!i){if(c-=1,c<=0)throw new Error("No outputs");await ee(10)}const u=(await Vt.getrawtransaction(i.txId,1)).result;const l=new p({network:ne});l.addInput({hash:i.txId,index:i.vout,nonWitnessUtxo:Buffer.from(u.hex,"hex")}),l.addOutput({script:Buffer.from(t,"hex"),value:parseInt(e,10)}),l.signInput(0,r),l.finalizeAllInputs();const d=l.extractTransaction();let v;for(await Vt.sendrawtransaction(d.toHex()),c=5;!v;)if(v=(await Et.selectByScriptHex(t)).filter((t=>t.txId===d.getId()))[0],!v){if(c-=1,c<=0)throw new Error("No outputs");await ee(10)}return n.status(200).json({txId:d.getId(),vout:v.vout,height:-1,satoshis:v.satoshis})}catch(t){return ot.error(`POST ${r} failed with error '${t.message}'`),n.status(500).json({error:t.message})}})),t.get("/tx/:txId/json",(async({params:{txId:t},url:e},r)=>{try{if(!t)return void r.status(500).json({error:"Missing input txId."});const e=await Wt.getRawJSON(t);e?r.status(200).json(e):r.status(404).json({error:"Not found"})}catch(t){ot.error(`GET ${e} failed with error '${t.message}'`),r.status(500).json({error:t.message})}})),t.post("/revs",(async({body:{ids:t},url:e},r)=>{try{if(void 0===t||0===t.length)return void r.status(404).json({error:"Missing input object ids."});const e=await Nt.getRevsByIds(t);r.status(200).json(e)}catch(t){ot.error(`POST ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.post("/revToId",(async({body:{rev:t},url:e},r)=>{try{if(!bt(t))return void r.status(400).json({error:"Invalid rev id"});const e=await Rt.getId(t);e&&r.status(200).json(e),r.status(404).json()}catch(t){ot.error(`POST ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.post("/rpc",(async({body:t,url:e},r)=>{try{if(!t||!t.method)throw new Error("Please provide appropriate RPC method name");if(!new RegExp(G).test(t.method))throw new Error("Method is not allowed");const e=function(t,e){if(void 0===Jt[t]||null===Jt[t])throw new Error("This RPC method does not exist, or not supported");const r=e.trim().split(" ");const n=Jt[t].trim().split(" ");if(0===e.trim().length&&0!==Jt[t].trim().length)throw new Error(`Too few params provided. Expected ${n.length} Provided 0`);if(0!==e.trim().length&&0===Jt[t].trim().length)throw new Error(`Too many params provided. Expected 0 Provided ${r.length}`);if(r.length<n.length)throw new Error(`Too few params provided. Expected ${n.length} Provided ${r.length}`);if(r.length>n.length)throw new Error(`Too many params provided. Expected ${n.length} Provided ${r.length}`);return 0===e.length?[]:r.map(((t,e)=>qt[n[e]](t)))}(t.method,t.params);const n=e.length?await Vt[t.method](...e):await Vt[t.method]();r.status(200).json({result:n})}catch(t){ot.error(`POST ${e} failed with error '${t.message}'`),r.status(404).json({error:t.message})}})),t.post("/non-standard-utxo",(async(t,e)=>{e.status(500).json({error:"Please upgrade to @bitcoin-computer/lib to the latest version."})})),t})();if("mainnet"===A)throw new Error("Mainnet is currently disabled in your jurisdiction");Fe.use(`/v1/${L}/${A}`,He),Fe.use("/v1/store",yt),De.listen(P,(()=>{ot.info(`\nStarted Bitcoin Computer Node Version ${lt}\nPORT ${P} \nBC_START_HEIGHT 3211111\n`)})).on("error",(t=>{ot.error(t.message),process.exit(1)}));const Ue=new a.Subscriber;Ue.connect(W),Ue.subscribe("rawtx"),ot.info(`ZMQ Subscriber connected to ${W}`),(async()=>{await(async()=>{await S((()=>dt.connect()),{startingDelay:500})})(),await ue.sub(Ue)})();
